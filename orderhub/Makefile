@docker compose=docker compose
SERVICE_NAME=localstack
TF_DIR := ./terraform
DOCKER_NETWORK ?= orderhub
TF_DOCKER_RUN := docker run --rm \
	-v $(PWD)/$(TF_DIR):/workspace --network $(DOCKER_NETWORK) -w /workspace \
	-e AWS_ACCESS_KEY_ID=test -e AWS_SECRET_ACCESS_KEY=test \
	-e AWS_DEFAULT_REGION=us-east-1 hashicorp/terraform:1.8

AWS_CLI_DOCKER_RUN = docker run --rm --network $(DOCKER_NETWORK) \
  -e AWS_ACCESS_KEY_ID=test -e AWS_SECRET_ACCESS_KEY=test amazon/aws-cli

LOCALSTACK_URL := http://mock-aws-services:4566

.PHONY: help
help:  ## ðŸ“– Help message
	@echo ""
	@echo "\033[1;33mAvailable commands:\033[0m" && \
	awk -F ':.*?## ' '/^[a-zA-Z0-9_.-]+:.*## / { \
		cmds[$$1] = $$2; \
		if (length($$1) > max_len) max_len = length($$1); \
	} \
	END { \
		for (cmd in cmds) { \
			printf "  \033[36m%-" max_len "s\033[0m %s\n", cmd, cmds[cmd]; \
		} \
	}' $(MAKEFILE_LIST) | sort
	@echo ""

.PHONY: init.infra
init.infra: ## ðŸŒ Create the infrastructure
	@docker network create $(DOCKER_NETWORK) || true

.PHONY: terraform.init
terraform.init: ## ðŸš€ Terraform Init
	@echo "ðŸš€ Terraform Init"
	$(TF_DOCKER_RUN) init

.PHONY: terraform.plan
terraform.plan: ## ðŸ” Terraform Plan
	@echo "ðŸ” Terraform Plan"
	$(TF_DOCKER_RUN) plan

.PHONY: terraform.apply
terraform.apply: ## âœ… Terraform Apply
	@echo "âœ… Terraform Apply"
	$(TF_DOCKER_RUN) apply -auto-approve

.PHONY: terraform.destroy
terraform.destroy: ## ðŸ”¥ Terraform Destroy
	@echo "ðŸ”¥ Terraform Destroy"
	$(TF_DOCKER_RUN) destroy -auto-approve

.PHONY: terraform.validate
terraform.validate: ##ðŸ”Ž Terraform Validate
	@echo "ðŸ”Ž Terraform Validate"
	$(TF_DOCKER_RUN) validate

.PHONY: terraform.fmt
terraform.fmt: ## ðŸ§¹ Terraform Format
	@echo "ðŸ§¹ Terraform Format"
	$(TF_DOCKER_RUN) fmt

.PHONY: terraform.show
terraform.show: ## ðŸ“œ Terraform Show"
	@echo "ðŸ“œ Terraform Show"
	$(TF_DOCKER_RUN) show

.PHONY: terraform.output
terraform.output:
	@echo "ðŸ“¦ Terraform Outputs"
	$(TF_DOCKER_RUN) output

.PHONY: start.infra
start.infra: ## ðŸš€ Start localstack services.
	@echo "ðŸš€ Starting LocalStack..."
	@docker compose up -d

.PHONY: stop.infra
stop.infra: ## ðŸ›‘ Stop LocalStack services.
	@echo "ðŸ›‘ Stopping LocalStack..."
	@docker compose down -v

.PHONY: init.infra
clean.infra: ## ðŸ§¹ Clean resources created for various services
	@echo "ðŸ§¹ Removing Temporary resources ..."
	@docker network rm $(DOCKER_NETWORK) || true

.PHONY: logs.infra
logs.infra: ## ðŸ“œ  Localstack logs
	@echo "ðŸ“œ infrastructure (localstack) logs..."
	@docker compose logs -f $(SERVICE_NAME)

.PHONY: ps.infra
ps.infra: ## ðŸ“¦ Container Status
	@echo "ðŸ“¦ Runtime Container Status ..."
	@docker compose ps

s3.list:  ## ðŸ“‚ List S3 buckets
	@echo "ðŸ“‚ Listing S3 Buckets..."
	@$(AWS_CLI_DOCKER_RUN) s3 ls --endpoint-url $(LOCALSTACK_URL)

sqs.list:  ## ðŸ“¬ List SQS queues
	@echo "ðŸ“¬ Listing SQS Queues..."
	@$(AWS_CLI_DOCKER_RUN) sqs list-queues --region us-east-1 \
		--endpoint-url $(LOCALSTACK_URL)

sns.list:  ## ðŸ“£ List SNS topics
	@echo "ðŸ“£ Listing SNS Topics..."
	@$(AWS_CLI_DOCKER_RUN) sns list-topics --region us-east-1 \
		--endpoint-url $(LOCALSTACK_URL)

ssm.list:  ## ðŸ“¦ List SSM parameters
	@echo "ðŸ“¦ Listing SSM Parameters..."
	@$(AWS_CLI_DOCKER_RUN) ssm get-parameters-by-path \
		--path "/config" --region us-east-1 \
		--endpoint-url $(LOCALSTACK_URL)

.PHONY: init
init: init.infra terraform.init ## Initialize development environment prerequisites
	@echo "[INFO] Initializing Gradle wrapper."
	@gradle wrapper

.PHONY: build
build: ## ðŸ—ï¸ Build all modules
	./gradlew build

.PHONY: test.unit
test.unit: ## ðŸ§ª Run unit tests
	./gradlew test

.PHONY: test.integration
test.integration: ## ðŸ§ª Run integration tests
	./gradlew integrationTest

.PHONY: clean
clean: ## ðŸ§¹ Clean all builds
	./gradlew clean


##--------------------------------------------------------------
##  --- Run Services, Stop Services, Look at logs  ---
##--------------------------------------------------------------

orderapi.start: ## ðŸš€ Start the Order API service
	@echo "ðŸš€ Starting Order API service..."
	@nohup ./gradlew :services:order-service-api:bootRun > /tmp/orderapi.log 2>&1 & echo $$! > /tmp/orderapi.pid && \
	echo "âœ… Order API running (log: /tmp/orderapi.log, pid: `cat /tmp/orderapi.pid`)"

orderapi.stop: ## âŒ Stop the Order API service
	@kill `cat /tmp/orderapi.pid` 2>/dev/null || echo "Order API not running"
	@rm -f /tmp/orderapi.pid

orderapi.logs: ## ðŸ“„ Tail logs for Order API
	@echo "ðŸ“„ Tailing /tmp/orderapi.log ..."
	@tail -f /tmp/orderapi.log

orderprocessor.start: ## âš™ï¸ Start the Order Processor service
	@echo "âš™ï¸  Starting Order Processor service..."
	@nohup ./gradlew :services:order-processor-service:bootRun > /tmp/orderprocessor.log 2>&1 & echo $$! > /tmp/orderprocessor.pid && \
	echo "âœ… Order Processor running (log: /tmp/orderprocessor.log, pid: `cat /tmp/orderprocessor.pid`)"

orderprocessor.stop: ## âŒ Stop the Order Processor service
	@kill `cat /tmp/orderprocessor.pid` 2>/dev/null || echo "Order Processor not running"
	@rm -f /tmp/orderprocessor.pid

orderprocessor.logs: ## ðŸ“„ Tail logs for Order Processor
	@echo "ðŸ“„ Tailing /tmp/orderprocessor.log ..."
	@tail -f /tmp/orderprocessor.log

notification.start: ## ðŸ“£ Start the Notification service
	@echo "ðŸ“£ Starting Notification service..."
	@nohup ./gradlew :services:notification-service:bootRun > /tmp/notification.log 2>&1 & echo $$! > /tmp/notification.pid && \
	echo "âœ… Notification running (log: /tmp/notification.log, pid: `cat /tmp/notification.pid`)"

notification.stop: ## âŒ Stop the Notification service
	@kill `cat /tmp/notification.pid` 2>/dev/null || echo "Notification not running"
	@rm -f /tmp/notification.pid

notification.logs: ## ðŸ“„ Tail logs for Notification Service
	@echo "ðŸ“„ Tailing /tmp/notification.log ..."
	@tail -f /tmp/notification.log

##--------------------------------------------------------------
